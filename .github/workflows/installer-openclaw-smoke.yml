name: Installer OpenClaw Smoke

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'setup-quaid.mjs'
      - 'setup-quaid.sh'
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/installer-openclaw-smoke.yml'
  push:
    branches: [main]
    paths:
      - 'setup-quaid.mjs'
      - 'setup-quaid.sh'
      - 'install.sh'
      - 'install.ps1'

jobs:
  openclaw-installer-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - fresh
          - stale-registry-upgrade
          - compaction-safeguard-upgrade
          - wrapper-missing
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install sqlite-vec prerequisite
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip sqlite-vec || \
          python -m pip install --user --break-system-packages sqlite-vec

      - name: Install OpenClaw
        run: npm install -g openclaw

      - name: Run installer matrix smoke
        shell: bash
        run: |
          set -euo pipefail

          export SCENARIO="${{ matrix.scenario }}"
          export HOME="${RUNNER_TEMP}/quaid-installer-home-${SCENARIO}"
          export XDG_CONFIG_HOME="${HOME}/.config"
          mkdir -p "${HOME}"
          WORKSPACE="${HOME}/workspace"
          mkdir -p "${WORKSPACE}"

          # Resolve OpenClaw CLI with fallback to direct node entry if wrapper is missing.
          OPENCLAW_BIN="$(command -v openclaw || true)"
          if [[ "${SCENARIO}" == "wrapper-missing" ]]; then
            OPENCLAW_BIN=""
          fi
          if [[ -n "${OPENCLAW_BIN}" ]]; then
            OC=( "${OPENCLAW_BIN}" )
          else
            OPENCLAW_ROOT="$(npm root -g)/openclaw"
            OPENCLAW_ENTRY=""
            for candidate in \
              "${OPENCLAW_ROOT}/dist/entry.js" \
              "${OPENCLAW_ROOT}/dist/cli.js" \
              "${OPENCLAW_ROOT}/bin/openclaw.js" \
              "${OPENCLAW_ROOT}/index.js"; do
              if [[ -f "${candidate}" ]]; then
                OPENCLAW_ENTRY="${candidate}"
                break
              fi
            done
            if [[ -n "${OPENCLAW_ENTRY}" ]]; then
              OC=( node "${OPENCLAW_ENTRY}" )
            else
              OC=( npx -y openclaw )
            fi
          fi

          # Fresh CI homes are unconfigured; allow bootstrap startup.
          "${OC[@]}" gateway --allow-unconfigured --port 18789 >"/tmp/openclaw-gateway-${SCENARIO}.log" 2>&1 &
          sleep 3
          "${OC[@]}" gateway probe || true

          if [[ "${SCENARIO}" == "stale-registry-upgrade" ]]; then
            python - <<'PY'
            import json, pathlib
            cfg = pathlib.Path.home()/".openclaw"/"openclaw.json"
            data = json.loads(cfg.read_text())
            plugins = data.setdefault("plugins", {})
            plugins.setdefault("slots", {})["memory"] = "quaid"
            plugins.setdefault("entries", {})["quaid"] = {
                "enabled": True,
                "workspace": str(pathlib.Path.home()/".openclaw"/"workspace"),
            }
            plugins.setdefault("installs", {})["quaid"] = {
                "source": "path",
                "sourcePath": "/tmp/missing-quaid-src",
                "installPath": str(pathlib.Path.home()/".openclaw"/"extensions"/"quaid"),
                "version": "0.0.0-test",
            }
            cfg.write_text(json.dumps(data, indent=2) + "\n")
            ext = pathlib.Path.home()/".openclaw"/"extensions"/"quaid"
            if ext.exists():
                import shutil
                shutil.rmtree(ext)
            print("seeded stale registry config")
          PY
          fi

          if [[ "${SCENARIO}" == "compaction-safeguard-upgrade" ]]; then
            python - <<'PY'
            import json, pathlib
            cfg = pathlib.Path.home()/".openclaw"/"openclaw.json"
            data = json.loads(cfg.read_text())
            agents = data.setdefault("agents", {})
            defaults = agents.setdefault("defaults", {})
            defaults.setdefault("compaction", {})["mode"] = "safeguard"
            cfg.write_text(json.dumps(data, indent=2) + "\n")
            print("seeded compaction safeguard mode")
          PY
          fi

          node setup-quaid.mjs --agent --workspace "${WORKSPACE}" --owner-name "CI Installer"
          node setup-quaid.mjs --agent --workspace "${WORKSPACE}" --owner-name "CI Installer"

          python - <<'PY'
          import json, pathlib

          cfg = pathlib.Path.home() / ".openclaw" / "openclaw.json"
          if not cfg.exists():
              raise SystemExit("openclaw.json missing after installer run")
          data = json.loads(cfg.read_text())
          plugins = data.get("plugins") or {}
          slots = plugins.get("slots") or {}
          entries = plugins.get("entries") or {}
          installs = plugins.get("installs") or {}
          agents = data.get("agents") or {}
          defaults = agents.get("defaults") or {}
          compaction = defaults.get("compaction") or {}
          hooks = ((data.get("hooks") or {}).get("internal") or {}).get("entries") or {}

          if slots.get("memory") != "quaid":
              raise SystemExit(f"expected plugins.slots.memory=quaid, got {slots.get('memory')!r}")
          if "quaid" not in entries:
              raise SystemExit("plugins.entries.quaid missing after install")
          if isinstance(entries.get("quaid"), dict) and "workspace" in entries["quaid"]:
              raise SystemExit("invalid plugins.entries.quaid.workspace key present")
          if "quaid" not in installs:
              raise SystemExit("plugins.installs.quaid missing after install")
          if compaction.get("mode") != "default":
              raise SystemExit(f"expected agents.defaults.compaction.mode=default, got {compaction.get('mode')!r}")
          if not (hooks.get("bootstrap-extra-files") or {}).get("enabled", False):
              raise SystemExit("required hook bootstrap-extra-files is not enabled")
          if not (hooks.get("session-memory") or {}).get("enabled", False):
              raise SystemExit("required hook session-memory is not enabled")

          ext = pathlib.Path.home() / ".openclaw" / "extensions" / "quaid"
          if not ext.exists():
              raise SystemExit(f"expected extension install path missing: {ext}")
          print("installer smoke assertions passed")
          PY

          "${OC[@]}" doctor | tee "/tmp/openclaw-doctor-${SCENARIO}.log"
          if grep -Eiq "plugin not found: quaid|Config invalid|stale config entry ignored" "/tmp/openclaw-doctor-${SCENARIO}.log"; then
            echo "Doctor output indicates stale/invalid quaid plugin state" >&2
            exit 1
          fi

          "${OC[@]}" gateway restart
          "${OC[@]}" doctor | tee "/tmp/openclaw-doctor-post-restart-${SCENARIO}.log"
          if grep -Eiq "plugin not found: quaid|Config invalid|stale config entry ignored" "/tmp/openclaw-doctor-post-restart-${SCENARIO}.log"; then
            echo "Doctor output indicates stale/invalid quaid plugin state after restart" >&2
            exit 1
          fi
