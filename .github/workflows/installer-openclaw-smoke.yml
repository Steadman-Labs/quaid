name: Installer OpenClaw Smoke

on:
  workflow_dispatch:
  pull_request:
    branches: [main]
    paths:
      - 'setup-quaid.mjs'
      - 'setup-quaid.sh'
      - 'install.sh'
      - 'install.ps1'
      - '.github/workflows/installer-openclaw-smoke.yml'
  push:
    branches: [main]
    paths:
      - 'setup-quaid.mjs'
      - 'setup-quaid.sh'
      - 'install.sh'
      - 'install.ps1'

jobs:
  openclaw-installer-smoke:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        scenario:
          - fresh
          - stale-registry-upgrade
          - compaction-safeguard-upgrade
          - wrapper-missing
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install sqlite-vec prerequisite
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install --upgrade pip sqlite-vec || \
          python -m pip install --user --break-system-packages sqlite-vec

      - name: Install OpenClaw
        run: npm install -g openclaw

      - name: Run installer matrix smoke
        shell: bash
        run: |
          set -euo pipefail

          export SCENARIO="${{ matrix.scenario }}"
          export XDG_CONFIG_HOME="${HOME}/.config"
          mkdir -p "${HOME}/.openclaw"
          if [[ ! -f "${HOME}/.openclaw/openclaw.json" ]]; then
            printf '{}\n' > "${HOME}/.openclaw/openclaw.json"
          fi
          WORKSPACE="${RUNNER_TEMP}/quaid-installer-workspace-${SCENARIO}"
          mkdir -p "${WORKSPACE}"
          export CLAWDBOT_WORKSPACE="${WORKSPACE}"
          export PATH="$(npm config get prefix)/bin:${PATH}"
          npm install --no-save @clack/prompts

          # Resolve OpenClaw CLI with fallback to direct node entry if wrapper is missing.
          OPENCLAW_ENTRY=""
          OPENCLAW_BIN="$(command -v openclaw || true)"
          if [[ "${SCENARIO}" == "wrapper-missing" ]]; then
            OPENCLAW_BIN=""
          fi
          if [[ -n "${OPENCLAW_BIN}" ]]; then
            OC=( "${OPENCLAW_BIN}" )
          else
            OPENCLAW_ROOT="$(npm root -g)/openclaw"
            for candidate in \
              "${OPENCLAW_ROOT}/dist/entry.js" \
              "${OPENCLAW_ROOT}/dist/cli.js" \
              "${OPENCLAW_ROOT}/bin/openclaw.js" \
              "${OPENCLAW_ROOT}/index.js"; do
              if [[ -f "${candidate}" ]]; then
                OPENCLAW_ENTRY="${candidate}"
                break
              fi
            done
            if [[ -n "${OPENCLAW_ENTRY}" ]]; then
              OC=( node "${OPENCLAW_ENTRY}" )
            else
              OC=( npx -y openclaw )
            fi
          fi
          if [[ -z "$(command -v openclaw || true)" && -n "${OPENCLAW_ENTRY}" ]]; then
            mkdir -p "${HOME}/.local/bin"
            printf '%s\n' '#!/usr/bin/env bash' "exec node \"${OPENCLAW_ENTRY}\" \"\$@\"" > "${HOME}/.local/bin/openclaw"
            chmod +x "${HOME}/.local/bin/openclaw"
            export PATH="${HOME}/.local/bin:${PATH}"
          fi

          start_gateway() {
            "${OC[@]}" gateway run --allow-unconfigured --force --port 18789 >"/tmp/openclaw-gateway-${SCENARIO}.log" 2>&1 &
            sleep 3
            if ! "${OC[@]}" gateway probe; then
              echo "gateway probe failed; dumping startup log" >&2
              cat "/tmp/openclaw-gateway-${SCENARIO}.log" >&2 || true
            fi
          }

          # Fresh CI homes are unconfigured; run foreground gateway in the background.
          start_gateway
          OPENCLAW_CFG_PATH="${HOME}/.openclaw/openclaw.json"
          if [[ ! -f "${OPENCLAW_CFG_PATH}" ]]; then
            OPENCLAW_CFG_PATH="$(find "${HOME}" -type f -name 'openclaw.json' 2>/dev/null | head -n1 || true)"
          fi
          if [[ -z "${OPENCLAW_CFG_PATH}" ]]; then
            OPENCLAW_CFG_PATH="${HOME}/.openclaw/openclaw.json"
          fi
          export OPENCLAW_CFG_PATH

          if [[ "${SCENARIO}" == "stale-registry-upgrade" ]]; then
            python -c "import json, os, pathlib, shutil; cfg=pathlib.Path(os.environ['OPENCLAW_CFG_PATH']); data=json.loads(cfg.read_text()); plugins=data.setdefault('plugins', {}); plugins.setdefault('slots', {})['memory']='quaid'; plugins.setdefault('entries', {})['quaid']={'enabled': True, 'workspace': str(pathlib.Path.home()/'.openclaw'/'workspace')}; plugins.setdefault('installs', {})['quaid']={'source':'path','sourcePath':'/tmp/missing-quaid-src','installPath':str(pathlib.Path.home()/'.openclaw'/'extensions'/'quaid'),'version':'0.0.0-test'}; cfg.write_text(json.dumps(data, indent=2) + '\n'); ext=pathlib.Path.home()/'.openclaw'/'extensions'/'quaid'; shutil.rmtree(ext) if ext.exists() else None; print(f'seeded stale registry config: {cfg}')"
          fi

          if [[ "${SCENARIO}" == "compaction-safeguard-upgrade" ]]; then
            python -c "import json, os, pathlib; cfg=pathlib.Path(os.environ['OPENCLAW_CFG_PATH']); data=json.loads(cfg.read_text()); agents=data.setdefault('agents', {}); defaults=agents.setdefault('defaults', {}); defaults.setdefault('compaction', {})['mode']='safeguard'; cfg.write_text(json.dumps(data, indent=2) + '\n'); print(f'seeded compaction safeguard mode: {cfg}')"
          fi

          node setup-quaid.mjs --agent --workspace "${WORKSPACE}" --owner-name "CI Installer"

          OPENCLAW_CFG_PATH="${HOME}/.openclaw/openclaw.json"
          if [[ ! -f "${OPENCLAW_CFG_PATH}" ]]; then
            OPENCLAW_CFG_PATH="$(find "${HOME}" -type f -name 'openclaw.json' 2>/dev/null | head -n1 || true)"
          fi
          export OPENCLAW_CFG_PATH

          python - <<'PY'
          import json, pathlib

          import os
          cfg = pathlib.Path(os.environ.get("OPENCLAW_CFG_PATH", str(pathlib.Path.home() / ".openclaw" / "openclaw.json")))
          if not cfg.exists():
              raise SystemExit("openclaw.json missing after installer run")
          data = json.loads(cfg.read_text())
          plugins = data.get("plugins") or {}
          entries = plugins.get("entries") or {}
          installs = plugins.get("installs") or {}
          agents = data.get("agents") or {}
          defaults = agents.get("defaults") or {}
          compaction = defaults.get("compaction") or {}
          hooks = ((data.get("hooks") or {}).get("internal") or {}).get("entries") or {}

          mode = compaction.get("mode")
          if isinstance(mode, str) and mode.strip() and mode.strip().lower() != "default":
              raise SystemExit(f"expected agents.defaults.compaction.mode=default when set, got {mode!r}")
          for hook_name in ("bootstrap-extra-files", "session-memory"):
              hook = hooks.get(hook_name)
              if isinstance(hook, dict) and hook and hook.get("enabled") is False:
                  raise SystemExit(f"required hook {hook_name} is explicitly disabled")

          install_path = (installs.get("quaid") or {}).get("installPath")
          ext = pathlib.Path(install_path) if isinstance(install_path, str) and install_path else None
          if ext is not None and not ext.exists():
              raise SystemExit(f"expected extension install path missing: {ext}")
          print("installer smoke assertions passed")
          PY

          "${OC[@]}" doctor | tee "/tmp/openclaw-doctor-${SCENARIO}.log"
          if grep -Eiq "plugin not found: quaid|Config invalid|stale config entry ignored" "/tmp/openclaw-doctor-${SCENARIO}.log"; then
            echo "Doctor output indicates stale/invalid quaid plugin state" >&2
            exit 1
          fi

          "${OC[@]}" gateway restart
          "${OC[@]}" doctor | tee "/tmp/openclaw-doctor-post-restart-${SCENARIO}.log"
          if grep -Eiq "plugin not found: quaid|Config invalid|stale config entry ignored" "/tmp/openclaw-doctor-post-restart-${SCENARIO}.log"; then
            echo "Doctor output indicates stale/invalid quaid plugin state after restart" >&2
            exit 1
          fi
